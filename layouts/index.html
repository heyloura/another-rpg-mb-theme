{{ define "main" }}
<section class="h-feed">

	<img style="display:block;margin: 0px auto;" width="562" height="19" src="https://web.archive.org/web/20091027102121im_/http://hk.geocities.com/footprints_kayi/border.gif" />
	{{ $paginator := .Paginate (where .Site.Pages.ByDate.Reverse "Type" "post") (index .Site.Params "archive-paginate" | default 20) }}
	{{ range $paginator.Pages  }}

		{{ if .Title }}
			<dl class="h-entry">
				<dt>
					<a href="{{ .Permalink }}" class="u-url p-name"> {{ .Title }} </a> ◊ <time class="dt-published" datetime="{{ .Date.Format "2006-01-02 15:04:05 -0700" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
					<span data-id="{{ .RelPermalink }}"></span>
				</dt>
				{{ if in .RawContent "<!--more-->" }}
				<dd class="p-summary">
				    <p>
				    {{ $splitContents := split .RawContent "<!--more-->" }}
				    {{ $summary := index $splitContents 0 }}
				    {{ $summary := replaceRE "\\[\\^.*?\\]" "" $summary }}
				    {{ $summary := replaceRE "\\n\\[\\^.*?\\]:.*" "" $summary }}
				    {{ $summary | markdownify }}
				    </p>
				    <p><a href="{{ .Permalink }}">Read More →</a></p>
				</dd>
			    {{ else }}
				<dd class="e-content">
				    {{ .Content }}
				</dd>
			    {{ end }}
			</dl>
		{{ else }}
			<dl class="h-entry">
				<dt>
					<a href="{{ .Permalink }}" class="u-url">
						<time class="dt-published" datetime="{{ .Date.Format "2006-01-02 15:04:05 -0700" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
					</a>
					<span data-id="{{ .RelPermalink }}"></span>
				</dt>
				<dd class="e-content">{{ .Content }}</dd>
			</dl>
		{{ end }}

		<script>
		  fetch('https://micro.blog/conversation.js?format=jsonfeed&url=https%3A%2F%2Fheyloura.com' + encodeURIComponent('{{ .RelPermalink }}'))
		  .then(response => response.json())
		  .then(conversation => {
		    const repliesLink = document.querySelector('[data-id="{{ .RelPermalink }}"]');
		    if(conversation.items.length > 0) {
		        let postA = document.createElement('a');
		        postA.setAttribute("href", '{{ .RelPermalink }}#conversation');
		        postA.innerHTML =  conversation.items.length + (conversation.items.length == 1 ? ' comment' : ' comments');
			let postSpan = document.createElement('span');
			postSpan.innerHTML = '◊ ';
		        repliesLink.prepend(postA);
			repliesLink.prepend(postSpan);
		    } else {
		        repliesLink.remove()
		    }
		  })
		  .catch((error) => {
		    // TODO: nothing for now…
		  });
		</script>
	
	{{ end }}
	{{ $pag := $.Paginator }}
	<nav>
		{{ if $pag.HasPrev }}
			<a rel='prev' href='{{ $pag.Prev.URL }}' title='Previous Page'>← Newer Posts</a>
		{{ end }}
		{{ if $pag.HasNext }}
			<a rel='next' href='{{ $pag.Next.URL }}'>Older Posts →</a>
		{{ end }}
	</nav>
</section>
{{ end }}
