<dialog id="gameModal" class="frame wooden-frame" style="display: flex;">
    <div class="grey-frame" style="max-width: 250px;">
        <p>Move using the WASD keys or by clicking the boxes around the player.</p>
        <button class="button" style="width:135px;" onclick="document.getElementById('gameModal').close();">Close</button>
        <a href="/game" class="button" style="width:135px;">About</a>
    </div>
	
	<div id="gameContainer" class="world">
        {{ partial (printf "areas/area_%s.html" "0") . }}
        {{ partial (printf "areas/area_%s.html" "1") . }}
        {{ partial (printf "areas/area_%s.html" "2") . }}
        {{ partial (printf "areas/area_%s.html" "3") . }}
    </div>
    <script>
        function movePlayer(playerEl, destinationEl) {
            if(destinationEl.disabled) {
                console.log('invalid move');
                return false;
            }

            var player = parseInt(playerEl.getAttribute('data-id'));
            var destination = parseInt(destinationEl.getAttribute('data-id'));

            // remove player graphic
            playerEl.removeAttribute('data-player')
            playerEl.classList.remove('knight-left');
            playerEl.classList.remove('knight-right');
            destinationEl.setAttribute('data-player','');

            //remove moves
            var moves = [...document.querySelectorAll('.move')];

            moves.forEach(element => {
                element.classList.remove('move');
            });

            var w = document.querySelector('[data-id="' + (destination - 18) + '"]');
            var a = document.querySelector('[data-id="' + (destination - 1) + '"]');
            var s = document.querySelector('[data-id="' + (destination + 18) + '"]');
            var d = document.querySelector('[data-id="' + (destination + 1) + '"]');

            if(player - destination == 1) {
                destinationEl.classList.add('knight-left');
            }
            if(player - destination == -1) {
                destinationEl.classList.add('knight-right');
            }
            if(player - destination < -1) {
                destinationEl.classList.add('knight-right');
            }
            if(player - destination > 1) {
                destinationEl.classList.add('knight-left');                    
            }

            if(a) {
                a.classList.add('move');
            }
            if(d) {
                d.classList.add('move');
            }
            if(w) {
                w.classList.add('move');
            }
            if(s) {
                s.classList.add('move');
            }
        }
        document.addEventListener("keydown", function(event) { 
            if(document.getElementById('gameModal').open) {
                var playerEl = document.querySelector('[data-player]');
                var player = parseInt(playerEl.getAttribute('data-id'));
                var destination = 0;
                switch (event.key) {
                    case 'w':
                        destination = player - 18;
                        console.log('W key pressed');
                        break;
                    case 'a':
                        destination = player - 1;
                        console.log('A key pressed');
                        break;
                    case 's':
                        destination = player + 18;
                        console.log('S key pressed');
                        break;
                    case 'd':
                        destination = player + 1;
                        console.log('D key pressed');
                        break;
                }

                movePlayer(playerEl, document.querySelector('[data-id="'+destination+'"]'));
            }
            return;
        });
        document.addEventListener("click", function(event) {
            if(event.target.hasAttribute('data-player')) {

            }

            if(event.target.classList.contains('move')) {
                movePlayer(document.querySelector('[data-player]'), event.target); 
            }
        });    
    </script>
</dialog>